<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
  <link rel="stylesheet" href="bootstrap/3.3.7/css/bootstrap.min.css">
  <!-- 可选的 Bootstrap 主题文件（一般不用引入） -->
  <link rel="stylesheet" href="bootstrap/3.3.7/css/bootstrap-theme.min.css">
  <script src="js/jquery-3.1.1.min.js"></script>
  <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
  <script src="bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="css/main.css">
  <title>加入微营力</title>
</head>

<body>
  <div style="height:50px;width:100%">

    <div style="float: right;margin-right: 13%;">
      <p style="color: #eca95b; font-size: 14px; margin-left: 10px;    line-height: 50px; vertical-align: middle">
        <a href="home.html" target="">返回首页</a>
      </p>
    </div>
  </div>

  <div style="width:100%; line-height: 80px; text-align: center;padding:6px;background: #2ea97a;color:white">
    <h2 style="">免费创建你的账号</h2>
  </div>
  <div style="width: 1000px; margin: 20px auto; height: 600px; border: 1px solid #e6e6e6;">

    <div id="rootwizard">
      <div class="navbar">
        <div class="navbar-inner">
          <div class="">
            <ul style="width:100%">
              <li style="width:33%"><a href="#tab1" data-toggle="tab">1.扫码二维码</a>
              </li>
              <li style="width:33%"><a href="#tab2" data-toggle="tab">2.微信价值评估</a>
              </li>
              <li style="width:33%"><a href="#tab3" data-toggle="tab">3.注册账号</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="tab-content">
        <div class="tab-pane active" id="tab1" style="text-align: center;">
            <div style="margin: 30px auto 50px;display: inline-block;">
              <h4>请使用微信扫描二维码加好友</h4>
              <img class="qrcode" src="img/wx_qrcode.jpg"/>
              <ul class="pager wizard">
                <li  class="next"><button>下一步</button>  </li>
              </ul>
            </div>
        </div>
        <div class="tab-pane" id="tab2" style="text-align: center;">
          <div id="layout_wx_login" class="tab2_section" style="margin: 30px auto 50px;display: inline-block;">
            <h4>打开微信，进入“扫一扫”<br/>扫码后在微信中点击“登录”</h4>
            <img id="qrcode" class="qrcode" />
            <br/>
            <span>申明：扫码登录，评估您微信号的价值，方便您接广告</span>

          </div>
          <div id="layout_refresh" class="tab2_section" style="margin: 30px auto 50px;display: inline-block;">
            <span id="layout_btn_refresh">二维码已经过期，请<a id ="a_refresh"href="#">刷新</a></span>
          </div>
          <img id="img_loading" src="img/loading.gif" class="tab2_section" style="margin: 30px auto 50px;display: inline-block;" />
          <div id="layout_wx_value" class="tab2_section" style="margin: 30px auto 50px;clear:both;">
            <table style="width:100%;">
              <tr>
                <td>
                  <label>好友数量</label> <span id="contactCount"></span>
                </td>
                <td>
                  <label>朋友圈报价</label> <span id="quota_price"></span>
                </td>
              </tr>
            </table>
            <div id="pie_sex" style="width:48%; height: 300px;float:left;"></div>
            <div id="pie_city" style="width:48%; height: 300px;float:left;"></div>
            <br/>
            <br/>
            <ul id="layout_qrcode_next" class="pager wizard" style="padding: 40px;clear: both;">
              <li class="next">
                <button>下一步</button>
              </li>
            </ul>
          </div>

        </div>
        <div class="tab-pane" id="tab3">
          <div style="width:40%;margin:auto">
            <form id="joinForm">
              <dl class="form-group">
                <dt class="input-label">
                  <label>手机号码</label>
                </dt>
                <dd>
                  <input type="text" class="form-control" placeholder="" name="mobile" />
                  <!-- /input-group -->
                  <p class="note"></p>
                </dd>
              </dl>
              <dl class="form-group">
                <dt class="input-label">
                  <label>动态验证码</label>
                </dt>
                <dd>
                  <div class="input-group">
                    <input autocapitalize="off" autofocus="autofocus" class="form-control" size="30" type="text" name="validateCode" />
                    <span class="input-group-btn" class="validationCode">
                      <img src="validateCode?v=xxx" id="img_validationCode"/> <a id ="btn_validationCode" href="#">换一张</a>
                    </span>
                  </div>
                  <p class="note"></p>
                </dd>
              </dl>
              <dl class="form-group">
                <dt class="input-label">
                  <label>手机验证码</label>
                </dt>
                <dd>
                  <div class="input-group">
                    <input type="text" class="form-control" placeholder="" name="mobileCode" />
                    <span class="input-group-btn">
                      <button id ="btn_mobile_code" class="btn btn-default" type="button" data-loading-text="发送中...">获取验证码</button>
                    </span>
                  </div>
                  <!-- /input-group -->
                  <p class="note"></p>
                </dd>
              </dl>
              <dl class="form-group">
                <dt class="input-label">
                  <label>密码</label>
                </dt>
                <dd>
                  <input autocapitalize="off" autofocus="autofocus" class="form-control" size="30" type="password" name="password" id="password" />
                  <p class="note"></p>
                </dd>
              </dl>
              <dl class="form-group">
                <dt class="input-label">
                  <label>确认密码</label>
                </dt>
                <dd>
                  <input id="confrimPassword" autocapitalize="off" autofocus="autofocus" class="form-control" size="30" type="password" name="confrimPassword" />
                  <p class="note"></p>
                </dd>
              </dl>
              <input type="hidden" id ="input_redirect_uri" name="redirect_uri"/>
              <input type="checkbox" aria-label="..." name ="agreement" value="Y"/>接受<a href="agreement.html" target="_blank">协议</a></p>
            </form>
            <button class="btn btn-primary" id="signup_button" data-disable-with="创建" data-loading-text="创建中...">创建个人账号</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="js/jquery.bootstrap.wizard.js"></script>
  <script src="js/canvasjs.min.js"></script>
  <script>
    window.QRLogin = {
      uuid: ''
    };
    window.Rmq = {
      CurUser: {},
      MemberList: []
    };
    $(document).ready(function() {
      $('#rootwizard').bootstrapWizard({
        onTabClick: function(tab, navigation, index) {
          return false;
        },
        onTabShow: function(tab, navigation, index) {
          if (index == 1) {
            showRefresh();
            $('#a_refresh').click();
          } else if (index == 2){
            $(".validationCode").click();
          }
        }
      });


      var groupCount = function(list, key) {
        var hash = {};
        for (var i = 0; i < list.length; i++) {
          var item = list[i];
          var keyValue = item[key];
          var count = hash[keyValue];
          if (count == null) {
            count = 0;
          }
          hash[keyValue] = ++count;
        }
        var result = new Array();
        for (var p in hash) {
          result.push({
            label: p,
            y: hash[p]
          });
        }
        return result;
      };

      var renderPie = function() {
        $("#contactCount").html(Rmq.MemberList.length);
        $("#quota_price").html(Rmq.MemberList.length / 40);

        var pie_sexData = groupCount(Rmq.MemberList, 'Sex');
        for (var i = 0; i < pie_sexData.length; i++) {
          var sex = '男';
          if(pie_sexData[i].label == 0){
            sex ='未知';
          }else if(pie_sexData[i].label ==2){
            sex ='女';
          }
          pie_sexData[i].label = sex ;
        }
        var chart = new CanvasJS.Chart("pie_sex", {
          theme: "theme2",
          height: 300,
          title: {
            text: "性别分布"
          },
          data: [{
            type: "pie",
            showInLegend: true,
            legendText: "{label}",
            dataPoints: pie_sexData
          }]
        });
        chart.render();

        var pie_cityData = groupCount(Rmq.MemberList, 'City');
        var chart = new CanvasJS.Chart("pie_city", {
          theme: "theme2",
          height: 300,
          title: {
            text: "地区分布"
          },
          data: [{
            type: "pie",
            showInLegend: true,
            legendText: "{label}",
            dataPoints: pie_cityData
          }]
        });
        chart.render();

      };
      var showRefresh = function() {
        $(".tab2_section").hide();
        $("#layout_refresh").show();
      };
      $('#a_refresh').click(function() {
        $(".tab2_section").hide();
        $("#img_loading").show();
        $("#layout_refresh").hide();
        reset();
      });

      var init = function() {
        $.get("initWx", {
          redirect_url: redirect_uri
        }, function(data, status) {
          Rmq.CurUser = data.User;
          getContact();
        }, "json").fail(function(jqXHR, textStatus, errorThrown) {
          debugger;
        });
      }

      var login = function() {
        console.log(redirect_uri);
        $.get("loginWx", {
          redirect_url: redirect_uri
        }, function(data, status) {
          $(".tab2_section").hide();
          $("#img_loading").show();
          init();
        });
      }

      var getContact = function() {
        $.ajax({
          type: "get",
          url: "getContact",
          data: {
            redirect_url: redirect_uri
          },
          contentType: "application/json",
          dataType: "json"
        }).done(function(data) {
          window.Rmq.MemberList = data.MemberList;
          $(".tab2_section").hide();
          $("#layout_wx_value").show();
          renderPie();
        }).fail(function(jqXHR, textStatus, errorThrown) {

        });
      }
      var reset = function() {
        var p = $.get("uuid").done(function(data) {
          eval(data);
          $("#qrcode").attr("src",
            "https://login.weixin.qq.com/qrcode/" + QRLogin.uuid);
          $(".tab2_section").hide();
          $("#layout_wx_login").show();
          listenScan();
        });
        var listenScan = function() {
          $.get("listenState", {
            uuid: QRLogin.uuid
          }, function(data, status) {
            eval(data);
            if (code == 201) {
              listenScan();
            } else if (code == 200) {
              login();
            } else if (code == 408) {
              listenScan();
            } else if (code = 400) {
              showRefresh();
            }
          });
        }
      }


      //login
      $(".validationCode").click(function(){
        $("#img_validationCode").attr("src", "validateCode?v=" + (new Date().getTime()));
      });

      $("#btn_mobile_code").click(function(){
        var $btn = $(this);
        $btn.button('loading');
        $.ajax({
          url : 'mobileValidationCode',
          type : 'POST',
          data : $('#joinForm').serialize()
        }).done(function(a, b, c) {
          $(".validationCode").click();
          alert(a);
        }).fail(function(xhr, textStatus, errorThrown) {
          alert(xhr.responseText);
          console.log(xhr);
          console.log(textStatus);
          console.log(errorThrown);
        }).always(function(){
          $btn.button("reset");
        });
      });


      $("#signup_button").click(function() {
        $("#input_redirect_uri").val(redirect_uri);
        var $btn = $(this);
        if($("#password").val() != $("input#confrimPassword").val()){
          alert('确认密码不正确');
          return;
        }
        $btn.button('loading');
        $.ajax({
          url : 'join',
          type : 'POST',
          data : $('#joinForm').serialize()
        }).done(function(a, b, c) {
          //window.location = 'login.html';
          
        }).fail(function(xhr, textStatus, errorThrown) {
          alert(xhr.responseText);
          console.log(xhr);
          console.log(textStatus);
          console.log(errorThrown);
        }).always(function(){
          $btn.button("reset");
        });
      });
    });
  </script>
</body>

</html>